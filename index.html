<!DOCTYPE html>
<html lang="zh-Hant-HK">
<head>
	<meta charset="utf-8">
	<title>港人有云</title>
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="css/normalize.css" rel="stylesheet" type="text/css">
	<link href="favicon.ico" rel="icon" type="image/x-icon">
</head>
<body>
	<nav>
		<div class="inline logo">
			港人有<u>云</u>
			<i class="inline fa fa-comment"></i>
		</div>
		<form method="get" class="search" onSubmit="$me.topic = topic.value;$switch('page_post');return false">
			<input class="borderless full-width" type="text" placeholder="討論話題 ......" name="topic"><button class="borderless" type="submit"><i class="fa fa-commenting-o"></i></button>
		</form>
	</nav>
	<div class="container">
		<div id="topic">
		</div>
		<div id="page_post">
			<table class="full-width">
				<thead>
					<tr>
						<th class="title">標題</th>
						<th class="score">評分</th>
					</tr>
				</thead>
				<tbody class="body">
				</tbody>
			</table>
		</div>
		<div id="page_topic">
			<div class="body">		
			</div>
		</div>
	</div>
	<div id="functionKey">
	
	</div>	
	<link href="fonts/font.css" rel="stylesheet" type="text/css">
	<link href="css/core.css" rel="stylesheet" type="text/css">
	<script>
		String.prototype.startsWith = function(searchString, position){position = position || 0;return this.substr(position, searchString.length) === searchString;};
		function jhr( url, callback, error ) {
			var xhr = new XMLHttpRequest();
			xhr.responseJSON = null;
			xhr.open( 'GET', url );
			xhr.setRequestHeader( 'Content-Type', 'application/json' );
			xhr.addEventListener('load',  function () {
				xhr.responseJSON = JSON.parse( xhr.responseText );
				callback( xhr.responseJSON, xhr );
			});
			xhr.addEventListener('error',  function () {
				error( xhr );
			});
			xhr.send();
			return xhr;
		}
		function $functionKey(){
			var body = document.getElementById("functionKey");
			body.innerHTML="";
			for (i=0;i<arguments.length;i++){
				switch(arguments[i]){
					case "post":
						body.innerHTML +='<a class="button" href="#"><i class="fa fa-plus fa-1x"></i> 話題</a>';
						break;
					case "return":
						body.innerHTML +='<a class="button" onclick="$return(\'page_post\')"><i class="fa fa-chevron-circle-left fa-1x"></i> 返回</a>';
						break;
					case "refresh":
						body.innerHTML +='<a class="button" onclick="$switch($me.page)"><i class="fa fa-refresh fa-1x"></i> 刷新</a>';
						break;
				}
			}
		}
		function $switch(page){
			$return(page);
			var body = document.querySelector("#"+page+" .body");
			body.innerHTML="";
			switch(page){
				case "page_post":
					document.querySelector("nav .search input").placeholder=$me.topic;
					$title($me.topic,"話題載入中......");
					jhr("JSON/posts.json?topic="+$me.topic,function(JSON){
						var title = Object.keys(JSON)[0];
						$title(title,JSON[title].description);
						for(posts in JSON[title].posts) {
							$post(body,JSON[title].posts[posts].title,0);
						}
						document.body.scrollTop = document.documentElement.scrollTop = 0;
					},function(){
						$title($me.topic,"話題載入失敗。");
						document.getElementById(page).style.display = "none";
						$functionKey("refresh");
					});
					break;
				case "page_topic":
					$comments(body,"Tom","hello",new Date().getTime());
					$comments(body,"Marry","hello",new Date().getTime());
					$comments(body,"j113203","Bonjour <3",new Date().getTime());
					document.body.scrollTop = document.documentElement.scrollTop = 0;
					break;
			}
		}
		function $post(a,t,d){a.innerHTML+="<tr><td onclick='$title(\""+t+"\",\"\");$switch(\"page_topic\")'>"+t+"</td><td>"+d+"</td></tr>"}
		function $comments(a,e,t,s){a.innerHTML+='<div class="chat'+(e==$me.name?" me":"")+'"><a class="user">'+e+'</a><div class="bubble">'+t+'</div><a class="date">'+simplify(s)+"</a></div>"}function simplify(e){var t=new Date;return e=new Date(e),e.toISOString().substr(0,10)==t.toISOString().substr(0,10)?e.getHours()==t.getHours()?e.getMinutes()==t.getMinutes()?t.getSeconds()-e.getSeconds()+"秒前":t.getMinutes()-e.getMinutes()+"分鐘前":t.getHours()-e.getHours()+"小時前":e.getFullYear()==t.getFullYear()?e.getMonth()==t.getMonth()?t.getDate()-e.getDate()+"日前":t.getMonth()-e.getMonth()+"個月前":t.getFullYear()-e.getFullYear()+"年前"}
		function $title(title,description){
			var topic = document.getElementById("topic");
			topic.style.display = "block";
			topic.innerHTML="<h3>"+title+"</h3><p>"+description+"</p>";
		}
		function $queryString( name) {
			name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
			var regexS = "[\\?&]"+name+"=([^&#]*)";
			var regex = new RegExp( regexS );
			var results = regex.exec( location.href );
			return results == null ? null : results[1];
		}
		function $switch_(page){
			$me.page = page;
			var page_ = document.getElementsByTagName('div');
			for (i=0;i<page_.length;i++){
				if (page_[i].id==page){
					page_[i].style.display = "block";
				}else if (page_[i].id.startsWith("page_")){
					page_[i].style.display = "none";
				}
			}
		}
		function $return(page){
			$switch_(page);
			switch(page){
				case "page_post":
					$functionKey("post","refresh");
					break;
				case "page_topic":
					$functionKey("return","refresh");
					break;
			}
		}
	</script>
	<script>
		var $me = {
			name : "j113203",
			page : "page_post",
			topic : ""
		};
		if ($queryString("topic")){
			$me.topic = $queryString("topic");
			$switch("page_post");
		}
		//$switch("page_topic");
	</script>
</body>
</html>